import { Shogi } from "@shogitter/core";
import { PossibilityScoringShogiGame } from "../src/players/possibilityistPlayer";
import { minimax } from "../src/search/minimax";
import type { randomSelect } from "../src/search/utils";
import { getShogiHelper } from "./helper";
import { describe, it, expect, beforeEach, vi } from "vitest";

vi.mock("../src/search/utils", () => {
  const randomSelectMock: typeof randomSelect = <T>(arr: T[]) => {
    return arr[0];
  };
  return {
    randomSelect: randomSelectMock,
  };
});

describe("posMaxSearch with Shogi", () => {
  let shogi;
  beforeEach(() => {
    shogi = Shogi.ofRuleId(0);
    shogi.start();
  });

  it("returns no move with depth=0", async () => {
    const game = new PossibilityScoringShogiGame(shogi);

    const result = minimax(game, 0);

    expect(result.moves).toHaveLength(0);
  });

  it("returns something with depth=1", async () => {
    const game = new PossibilityScoringShogiGame(shogi);

    const result = minimax(game, 1);

    expect(result).toMatchInlineSnapshot(`"7776 4"`);
  });
  describe("position related to check mate", () => {
    let helper;
    beforeEach(() => {
      helper = getShogiHelper(0);
      const { shogi, move, put } = helper;
      move(7, 7, 7, 6);
      move(4, 3, 4, 4);
      move(8, 8, 4, 4);
      move(8, 2, 4, 2);
      move(4, 4, 5, 3, true);
      move(4, 2, 4, 7, true);
      move(8, 9, 7, 7);
      move(4, 7, 5, 7);
      move(2, 8, 5, 8);
      move(5, 7, 5, 3);
      move(5, 8, 5, 3, true);
      put(5, 2, "aa");
      move(5, 3, 6, 3);
      move(3, 3, 3, 4);
      put(6, 4, "ag");
      move(2, 2, 7, 7, true);
      move(7, 9, 6, 8);
      move(7, 7, 9, 9);
      put(4, 3, "aa");
    });
    it("finds check mate", async () => {
      const { shogi, move, put } = helper;
      move(9, 9, 2, 2);

      const game = new PossibilityScoringShogiGame(shogi);

      const result1 = minimax(game, 1, true);
      const { trace, ...result1_ } = result1;
      expect(result1_).toMatchInlineSnapshot(`"6361 Infinity"`);
      expect(result1).toMatchSnapshot();

      {
        const result2 = minimax(game, 2, true);
        const { trace, ...result2_ } = result2;
        expect(result2_).toMatchInlineSnapshot(`"6361 Infinity"`);
        expect(result2).toMatchSnapshot();
      }
    });

    it("avoids check mate", async () => {
      const { shogi, move, put } = helper;

      const game = new PossibilityScoringShogiGame(shogi);

      const result1 = minimax(game, 1, true);
      const { trace, ...result1_ } = result1;
      expect(result1_).toMatchInlineSnapshot(`"9966 -141"`);
      expect(result1).toMatchSnapshot();

      {
        const result2 = minimax(game, 2, true);
        const { trace, ...result2_ } = result2;
        expect(result2_).toMatchInlineSnapshot(`"7162 -82"`);
        expect(result2).toMatchSnapshot();
      }
    });
  });

  describe("teban rotation", () => {
    it("searches with Shishi", () => {
      const { move, put, shogi } = getShogiHelper(22);

      const game = new PossibilityScoringShogiGame(shogi);
      expect(minimax(game, 1, true)).toMatchInlineSnapshot(`
        "5133 27
        5133 27
        5143 27
        5153 27
        5163 27
        5173 27
        5132 32
        5142 43
        5152 43
        5162 43
        5172 32
        5131 37
        5141 46
        5161 46
        5171 37"
      `);
      expect(minimax(game, 2, true)).toMatchInlineSnapshot(`
        "5142 27
        5133 7776 31
        5133 1716 28
        5133 1918 26
        5133 2726 28
        5133 2838 27
        5133 2848 27
        5133 2858 27
        5133 2868 27
        5133 2878 27
        5133 2818 26
        5133 3736 27
        5133 3948 25
        5133 3938 24
        5133 4746 27
        5133 4958 25
        5133 4948 24
        5133 4938 23
        5133 5756 27
        5133 5968 28
        5133 5958 27
        5133 5948 26
        5133 6766 27
        5133 6978 27
        5133 6968 26
        5133 6958 25
        5133 7776 31
        5133 7978 28
        5133 7968 27
        5133 8786 27
        5133 9796 28
        5133 9998 26
        5143 7776 33
        5143 1716 28
        5143 1918 26
        5143 2726 28
        5143 2838 27
        5143 2848 27
        5143 2858 27
        5143 2868 27
        5143 2878 27
        5143 2818 26
        5143 3736 27
        5143 3948 25
        5143 3938 24
        5143 4746 27
        5143 4958 25
        5143 4948 24
        5143 4938 23
        5143 5756 27
        5143 5968 28
        5143 5958 27
        5143 5948 26
        5143 6766 27
        5143 6978 27
        5143 6968 26
        5143 6958 25
        5143 7776 33
        5143 7978 28
        5143 7968 27
        5143 8786 27
        5143 9796 28
        5143 9998 26
        5153 7776 33
        5153 1716 28
        5153 1918 26
        5153 2726 28
        5153 2838 27
        5153 2848 27
        5153 2858 27
        5153 2868 27
        5153 2878 27
        5153 2818 26
        5153 3736 27
        5153 3948 25
        5153 3938 24
        5153 4746 27
        5153 4958 25
        5153 4948 24
        5153 4938 23
        5153 5756 27
        5153 5968 28
        5153 5958 27
        5153 5948 26
        5153 6766 27
        5153 6978 27
        5153 6968 26
        5153 6958 25
        5153 7776 33
        5153 7978 28
        5153 7968 27
        5153 8786 27
        5153 9796 28
        5153 9998 26
        5163 7776 33
        5163 1716 28
        5163 1918 26
        5163 2726 28
        5163 2838 27
        5163 2848 27
        5163 2858 27
        5163 2868 27
        5163 2878 27
        5163 2818 26
        5163 3736 27
        5163 3948 25
        5163 3938 24
        5163 4746 27
        5163 4958 25
        5163 4948 24
        5163 4938 23
        5163 5756 27
        5163 5968 28
        5163 5958 27
        5163 5948 26
        5163 6766 27
        5163 6978 27
        5163 6968 26
        5163 6958 25
        5163 7776 33
        5163 7978 28
        5163 7968 27
        5163 8786 27
        5163 9796 28
        5163 9998 26
        5173 7776 33
        5173 1716 28
        5173 1918 26
        5173 2726 28
        5173 2838 27
        5173 2848 27
        5173 2858 27
        5173 2868 27
        5173 2878 27
        5173 2818 26
        5173 3736 27
        5173 3948 25
        5173 3938 24
        5173 4746 27
        5173 4958 25
        5173 4948 24
        5173 4938 23
        5173 5756 27
        5173 5968 28
        5173 5958 27
        5173 5948 26
        5173 6766 27
        5173 6978 27
        5173 6968 26
        5173 6958 25
        5173 7776 33
        5173 7978 28
        5173 7968 27
        5173 8786 27
        5173 9796 28
        5173 9998 26
        5132 7776 38
        5132 1716 33
        5132 1918 31
        5132 2726 33
        5132 2838 32
        5132 2848 32
        5132 2858 32
        5132 2868 32
        5132 2878 32
        5132 2818 31
        5132 3736 32
        5132 3948 30
        5132 3938 29
        5132 4746 32
        5132 4958 30
        5132 4948 29
        5132 4938 28
        5132 5756 32
        5132 5968 33
        5132 5958 32
        5132 5948 31
        5132 6766 32
        5132 6978 32
        5132 6968 31
        5132 6958 30
        5132 7776 38
        5132 7978 33
        5132 7968 32
        5132 8786 32
        5132 9796 33
        5132 9998 31
        5142 4233 27
        5142 4233 27
        5142 4243 27
        5142 4253 27
        5142 4232 32
        5142 4252 32
        5142 4231 37
        5142 4241 37
        5142 4251 37
        5152 5243 27
        5152 5243 27
        5152 5253 27
        5152 5263 27
        5152 5242 32
        5152 5262 32
        5152 5241 37
        5152 5251 37
        5152 5261 37
        5162 6253 27
        5162 6253 27
        5162 6263 27
        5162 6273 27
        5162 6252 32
        5162 6272 32
        5162 6251 37
        5162 6261 37
        5162 6271 37
        5172 7776 38
        5172 1716 33
        5172 1918 31
        5172 2726 33
        5172 2838 32
        5172 2848 32
        5172 2858 32
        5172 2868 32
        5172 2878 32
        5172 2818 31
        5172 3736 32
        5172 3948 30
        5172 3938 29
        5172 4746 32
        5172 4958 30
        5172 4948 29
        5172 4938 28
        5172 5756 32
        5172 5968 33
        5172 5958 32
        5172 5948 31
        5172 6766 32
        5172 6978 32
        5172 6968 31
        5172 6958 30
        5172 7776 38
        5172 7978 33
        5172 7968 32
        5172 8786 32
        5172 9796 33
        5172 9998 31
        5131 7776 43
        5131 1716 38
        5131 1918 36
        5131 2726 38
        5131 2838 37
        5131 2848 37
        5131 2858 37
        5131 2868 37
        5131 2878 37
        5131 2818 36
        5131 3736 37
        5131 3948 35
        5131 3938 34
        5131 4746 37
        5131 4958 35
        5131 4948 34
        5131 4938 33
        5131 5756 37
        5131 5968 38
        5131 5958 37
        5131 5948 36
        5131 6766 37
        5131 6978 37
        5131 6968 36
        5131 6958 35
        5131 7776 43
        5131 7978 38
        5131 7968 37
        5131 8786 37
        5131 9796 38
        5131 9998 36
        5141 4132 32
        5141 4132 32
        5141 4142 32
        5141 4152 32
        5141 4131 37
        5141 4151 37
        5161 6152 32
        5161 6152 32
        5161 6162 32
        5161 6172 32
        5161 6151 37
        5161 6171 37
        5171 7776 43
        5171 1716 38
        5171 1918 36
        5171 2726 38
        5171 2838 37
        5171 2848 37
        5171 2858 37
        5171 2868 37
        5171 2878 37
        5171 2818 36
        5171 3736 37
        5171 3948 35
        5171 3938 34
        5171 4746 37
        5171 4958 35
        5171 4948 34
        5171 4938 33
        5171 5756 37
        5171 5968 38
        5171 5958 37
        5171 5948 36
        5171 6766 37
        5171 6978 37
        5171 6968 36
        5171 6958 35
        5171 7776 43
        5171 7978 38
        5171 7968 37
        5171 8786 37
        5171 9796 38
        5171 9998 36"
      `);
    });
  });
});
